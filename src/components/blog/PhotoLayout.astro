---
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import BackLink from './BackLink.astro';
import SiteHeader from './SiteHeader.astro';
import PostNav from './PostNav.astro';
import Carousel from './Carousel';

interface Props {
  post: CollectionEntry<'blog'>;
  prev?: CollectionEntry<'blog'>;
  next?: CollectionEntry<'blog'>;
}

const { post, prev, next } = Astro.props;
const { title, date, location, tag, images } = post.data;

const carouselImages = images?.map((img) => ({
  src: img.src.src,
  caption: img.caption,
})) || [];

// Format date as "MMM YYYY"
const formattedDate = date.toLocaleDateString('en-US', {
  month: 'short',
  year: 'numeric'
}).toUpperCase();
---

<div class="blog-container">
  <SiteHeader currentPage="essays" />

  <header class="blog-header">
    <BackLink label="Gallery" />
  </header>

  <main class="blog-content">
    <article>
      <header class="post-header">
        <div class="post-meta-row">
          <span class="meta-date">{formattedDate}</span>
          {location && <span class="meta-location">{location}</span>}
          {tag && <span class="meta-tag">{tag}</span>}
        </div>
        <h1 class="post-title">{title}</h1>
        <div class="article-rule"></div>
      </header>

      {images && images.length > 0 && (
        <div class="photo-grid">
          {images.map((image, index) => (
            <figure
              class="photo-grid-item"
              data-carousel-trigger
              data-index={index}
            >
              <Image
                src={image.src}
                alt={image.caption || title}
                class="photo-grid-img"
                widths={[400, 800, 1200]}
                sizes="(max-width: 768px) 100vw, 720px"
              />
              {image.caption && (
                <figcaption class="photo-grid-caption">{image.caption}</figcaption>
              )}
            </figure>
          ))}
        </div>
      )}

      <div class="prose">
        <slot />
      </div>
    </article>

    <PostNav prev={prev} next={next} />
  </main>
</div>

{carouselImages.length > 0 && (
  <Carousel images={carouselImages} client:load />
)}

<script>
  document.querySelectorAll('[data-carousel-trigger]').forEach((el) => {
    el.addEventListener('click', () => {
      const index = parseInt(el.getAttribute('data-index') || '0', 10);
      window.dispatchEvent(new CustomEvent('open-carousel', { detail: { index } }));
    });
  });
</script>
